
{{ $src := .Get "src" }}
{{ if not $src }}
  {{ errorf "The video_player shortcode requires a 'src' parameter." }}
{{ end }}

{{ $ratioStr := default "16:9" (.Get "ratio") }}
{{ $aspectMap := dict "16:9" "aspect-16-9" "9:16" "aspect-9-16" "4:3" "aspect-4-3" "3:4" "aspect-3-4" }}
{{ $aspectClass := index $aspectMap $ratioStr | default "aspect-16-9" }}

{{ $autoplay := eq (.Get "autoplay") "true" }}
{{ $loop := eq (.Get "loop") "true" }}

{{ $vpID := printf "vp-%d" .Ordinal }}

<div id="{{ $vpID }}" class="video-container {{ $aspectClass }}">
  <video class="video-player" src="{{ $src }}" playsinline {{ if $autoplay }}autoplay muted{{ end }} {{ if $loop }}loop{{ end }}></video>
  <div class="video-overlay"></div>

  <!-- Video Controls Toolbar -->
  <div class="video-toolbar">
    <!-- Left: Play/Pause Button -->
    <button id="{{ $vpID }}-play-pause-btn" class="toolbar-btn play-pause-btn" aria-label="Play/Pause">
      <svg id="{{ $vpID }}-play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon play-icon">
        <path d="M8 5v14l11-7z" />
      </svg>
      <svg id="{{ $vpID }}-pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon pause-icon" style="display: none;">
        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
      </svg>
    </button>
    
    <!-- Spacer -->
    <div class="toolbar-spacer"></div>

    <!-- Right: Fullscreen Button -->
    <button id="{{ $vpID }}-fullscreen-btn" class="toolbar-btn" aria-label="Toggle Fullscreen">
      <svg id="{{ $vpID }}-fullscreen-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon">
        <path d="M4 8V4h4M4 4l5 5m11-5v4h-4m4-4l-5 5M4 16v4h4M4 20l5-5m11 5v-4h-4m4 4l-5-5"/>
      </svg>
    </button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const vpID = '{{ $vpID }}';
  const videoContainer = document.getElementById(vpID);
  const video = videoContainer.querySelector('.video-player');
  const playPauseBtn = document.getElementById(`${vpID}-play-pause-btn`);
  const playIcon = document.getElementById(`${vpID}-play-icon`);
  const pauseIcon = document.getElementById(`${vpID}-pause-icon`);
  const fullscreenBtn = document.getElementById(`${vpID}-fullscreen-btn`);
  const fullscreenIcon = document.getElementById(`${vpID}-fullscreen-icon`);

  // Play/Pause toggle logic
  function togglePlayPause() {
    if (video.paused || video.ended) {
      video.play();
    } else {
      video.pause();
    }
  }

  playPauseBtn.addEventListener('click', togglePlayPause);
  video.addEventListener('click', togglePlayPause);
  video.addEventListener('play', () => {
    playIcon.style.display = 'none';
    pauseIcon.style.display = 'block';
  });
  video.addEventListener('pause', () => {
    playIcon.style.display = 'block';
    pauseIcon.style.display = 'none';
  });

  // Fullscreen toggle logic
  const enterFullscreen = () => {
    if (videoContainer.requestFullscreen) videoContainer.requestFullscreen();
    else if (videoContainer.webkitRequestFullscreen) videoContainer.webkitRequestFullscreen();
    else if (videoContainer.msRequestFullscreen) videoContainer.msRequestFullscreen();
  };
  const exitFullscreen = () => {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    else if (document.msExitFullscreen) document.msExitFullscreen();
  };
  
  if (fullscreenBtn) {
    fullscreenBtn.addEventListener('click', () =>
      document.fullscreenElement ? exitFullscreen() : enterFullscreen()
    );
  }

  document.addEventListener('fullscreenchange', () => {
    const isFull = !!document.fullscreenElement;
    videoContainer.classList.toggle('fullscreen', isFull);
    if (isFull) {
      fullscreenIcon.innerHTML = '<path d="M10 14L8 12M14 10L16 12M12 12L14 10M12 12L10 14M12 12L8 16M12 12L16 8M12 12L8 8M12 12L16 16"/>';
    } else {
      fullscreenIcon.innerHTML = '<path d="M4 8V4h4M4 4l5 5m11-5v4h-4m4-4l-5 5M4 16v4h4M4 20l5-5m11 5v-4h-4m4 4l-5-5"/>';
    }
  });
});
</script>

<style>
/* Aspect Ratios */
.aspect-16-9 { padding-top: 56.25%; }
.aspect-9-16 { padding-top: 177.78%; }
.aspect-4-3  { padding-top: 75%; }
.aspect-3-4  { padding-top: 133.33%; }

/* Video Container */
.video-container {
  position: relative;
  width: 100%;
  background: #000;
  border-radius: 1rem;
  box-shadow: 0 8px 30px rgba(0,0,0,0.5);
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.video-container.fullscreen {
  position: fixed !important;
  inset: 0;
  width: 100vw;
  height: 100vh;
  padding-top: 0 !important;
  border-radius: 0;
  z-index: 9999;
}

/* Video Player */
.video-player {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Toolbar and Overlay */
.video-toolbar, .video-overlay {
  position: absolute;
  left: 0;
  width: 100%;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease-in-out;
}
.video-overlay {
  top: 0;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
}
.video-toolbar {
  bottom: 0;
  height: 48px;
  background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
  display: flex;
  align-items: center;
  padding: 0 1rem;
  box-sizing: border-box;
}

/* Show toolbar on hover */
.video-container:hover .video-toolbar,
.video-container:hover .video-overlay,
.video-container.fullscreen .video-toolbar,
.video-container.fullscreen .video-overlay {
  opacity: 1;
  pointer-events: auto;
}

/* Toolbar Buttons */
.toolbar-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: transparent;
  color: white;
  border: none;
  cursor: pointer;
  transition: background 0.3s;
  border-radius: 50%;
}
.toolbar-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}
.toolbar-btn svg {
  width: 24px;
  height: 24px;
  fill: currentColor;
}
.toolbar-spacer {
  flex: 1;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .video-container { border-radius: 0.5rem; }
  .video-toolbar {
    height: 36px;
    padding: 0 0.5rem;
  }
  .toolbar-btn {
    width: 32px;
    height: 32px;
  }
  .toolbar-btn svg {
    width: 20px;
    height: 20px;
  }
}
</style>
